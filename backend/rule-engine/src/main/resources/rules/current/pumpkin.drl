package rules.current;

import com.agriscope.rule_engine.domain.model.CurrentWeatherData
import com.agriscope.rule_engine.domain.model.Seed
import com.agriscope.rule_engine.domain.model.Recommendation
import com.agriscope.rule_engine.domain.enums.SeedType
import com.agriscope.rule_engine.domain.enums.RecommendationType

global java.util.List recommendations;

rule "Pumpkin - Frost Alert"
when
    $seed: Seed(seedType == SeedType.PUMPKIN)
    $weather: CurrentWeatherData(temperature_2m < $seed.frostRiskTemperature)
then
    Recommendation rec = new Recommendation();
    rec.setUserId($weather.getUserId());
    rec.setRecommendedSeed(SeedType.PUMPKIN);
    rec.setRecommendationType(RecommendationType.FROST_ALERT);
    rec.setAdvice("COVER_WITH_FLEECE_IMMEDIATELY");
    rec.setReasoning("Temperature (" + $weather.getTemperature_2m() + "C) below frost risk threshold (" + $seed.getFrostRiskTemperature() + "°C)");
    rec.setWeatherTimestamp($weather.getTime());
    recommendations.add(rec);
end

rule "Pumpkin - Heat Stress Alert"
when
    $seed: Seed(seedType == SeedType.PUMPKIN)
    $weather: CurrentWeatherData(temperature_2m > $seed.heatStressTemperature)
then
    Recommendation rec = new Recommendation();
    rec.setUserId($weather.getUserId());
    rec.setRecommendedSeed(SeedType.PUMPKIN);
    rec.setRecommendationType(RecommendationType.HEAT_ALERT);
    rec.setAdvice("IRRIGATE_TO_PREVENT_FLOWER_DROP");
    rec.setReasoning("Temperature (" + $weather.getTemperature_2m() + "C) above heat stress threshold (" + $seed.getHeatStressTemperature() + "°C)");
    rec.setWeatherTimestamp($weather.getTime());
    recommendations.add(rec);
end

rule "Pumpkin - Optimal Conditions"
when
    $seed: Seed(seedType == SeedType.PUMPKIN)
    $weather: CurrentWeatherData(
        temperature_2m >= $seed.minTemperature && temperature_2m <= $seed.maxTemperature,
        rain < $seed.heavyRainThreshold
    )
then
    Recommendation rec = new Recommendation();
    rec.setUserId($weather.getUserId());
    rec.setRecommendedSeed(SeedType.PUMPKIN);
    rec.setRecommendationType(RecommendationType.CONTINUE_NORMAL);
    rec.setAdvice("CONTINUE_NORMAL_PUMPKIN_OPERATIONS");
    rec.setReasoning("Optimal conditions for pumpkin - temp: " + $weather.getTemperature_2m() + "C, rain: " + $weather.getRain() + "mm");
    rec.setWeatherTimestamp($weather.getTime());
    recommendations.add(rec);
end